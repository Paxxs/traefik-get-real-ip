# Traefik è·å–çœŸå® IP åœ°å€

<!-- cspell:words traefik middlewares proxyHeadername proxyHeadervalue Kubernetes -->

å½“ Traefik éƒ¨ç½²åœ¨å¤šä¸ªè´Ÿè½½å‡è¡¡å™¨åé¢æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æ­¤æ’ä»¶æ£€æµ‹ä¸åŒçš„è´Ÿè½½å‡è¡¡å™¨å¹¶ä»ä¸åŒçš„å¤´éƒ¨å­—æ®µæå–çœŸå® IPï¼Œç„¶åå°†è¯¥å€¼è¾“å‡ºåˆ° `x-real-ip` å¤´éƒ¨ã€‚

æ­¤æ’ä»¶å¯ä»¥é€šè¿‡æ£€æŸ¥è´Ÿè½½å‡è¡¡å™¨æ¥æ”¶åˆ°çš„å¤´éƒ¨ä¿¡æ¯å€¼æ˜¯å¦åŒ¹é…æ¥é˜²æ­¢ IP æ¬ºéª—ï¼Œç„¶åå†æå– IP åœ°å€ã€‚

ä¾‹å¦‚ï¼Œåœ¨ä¸‹é¢å±•ç¤ºçš„ `CloudFlare` è´Ÿè½½å‡è¡¡å™¨é…ç½®ä¸­ï¼Œæˆ‘ä»¬å°†å…¶é…ç½®ä¸ºåªæ¥å—å¤´éƒ¨ `x-from-cdn` ä¸”å€¼ç­‰äº `cf-foo`ï¼Œå¹¶ä» `Cf-Connecting-Ip` å¤´éƒ¨æå– IP åœ°å€ã€‚ç”±äºç”¨æˆ·æ°¸è¿œä¸çŸ¥é“ `x-from-cdn` å¤´éƒ¨çš„å­˜åœ¨æˆ–å…¶æ‰€éœ€çš„å€¼ `cf-foo`ï¼Œå› æ­¤å®ƒä¿æŒå®‰å…¨ ğŸ›¡ï¸ã€‚ä¸ºäº†å¢åŠ å¤æ‚æ€§å¹¶é¿å…è¢«çŒœæµ‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨éšæœºå­—ç¬¦ä¸² :)

```
 CloudFlare
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ x-from-cdn:cf-foo                 â”‚       â”‚        â”‚
            Cf-Connecting-Ip: realip          â”‚       â”‚        â”‚
 CDN2                                         â”‚       â”‚        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚       â”‚ paxxs'sâ”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚traefikâ”‚        â”‚ x-real-ip:realip
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ x-from-cdn:mf-bar                 â”‚       â”‚Get-rea â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
            Client-iP: realip                 â”‚       â”‚ l-ip   â”‚
 CDN3                                         â”‚       â”‚Plugin  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚       â”‚        â”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚       â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ x-from-cdn:mf-fun                 â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            x-forwarded-for: realip,x.x.x.x
                           (truthedIP)          â–²  â–²
                                                â”‚  â”‚
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚  â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   "*"                                             â”‚
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                RemoteAddr/etc..        â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## CDN é…ç½®

ä¾‹å¦‚ Cloudflare:

è§„åˆ™ > è½¬æ¢è§„åˆ™ > HTTP è¯·æ±‚å¤´éƒ¨ä¿®æ”¹ > æ·»åŠ 
- è®¾ç½®é™æ€å¤´éƒ¨: `X-From-Cdn`
  - å€¼: `cf-foo`

![image](https://user-images.githubusercontent.com/10364775/164590908-43edab8a-cdc8-4d4c-abd6-542b6c798f3b.png)

![image](https://user-images.githubusercontent.com/10364775/164591134-4dd2fc97-cd0e-4deb-8fe3-bcd4555ebbde.png)

## Traefik é…ç½®
### é™æ€é…ç½®

æ’ä»¶ä¿¡æ¯:
- æ¨¡å—åç§°: `github.com/Paxxs/traefik-get-real-ip`
- ç‰ˆæœ¬: `v1.0.2`

Traefik é…ç½®:
- yml
- toml
- docker-labels

```yml
pilot:
  token: [å·²ç¼–è¾‘]

experimental:
  plugins:
    real-ip:
      moduleName: github.com/Paxxs/traefik-get-real-ip
      version: [è¯·å¡«å†™æœ€æ–°ç‰ˆæœ¬!]
```

### åŠ¨æ€é…ç½®

- yml
- toml
- docker labels
- Kubernetes

```yml
http:
  middlewares:
    real-ip-foo:
      plugin:
        real-ip:
          enableLog: false # é»˜è®¤: falseï¼Œå¯ç”¨ä»¥æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
          Proxy:
            - proxyHeadername: X-From-Cdn
              proxyHeadervalue: mf-fun
              realIP: X-Forwarded-For
            - proxyHeadername: X-From-Cdn
              proxyHeadervalue: mf-bar
              realIP: Client-Ip
              OverwriteXFF: true # é»˜è®¤: falseï¼Œv1.0.2 æˆ–æ›´é«˜ç‰ˆæœ¬
            - proxyHeadername: X-From-Cdn
              proxyHeadervalue: cf-foo
              realIP: Cf-Connecting-Ip
              OverwriteXFF: true # é»˜è®¤: falseï¼Œv1.0.2 æˆ–æ›´é«˜ç‰ˆæœ¬
            - proxyHeadername: "*"
              realIP: RemoteAddr

  routers:
    my-router:
      rule: Host(`localhost`)
      middlewares:
        - real-ip-foo
      service: my-service

  services:
    my-service:
      loadBalancer:
        servers:
          - url: 'http://127.0.0.1'
```

## é…ç½®é€‰é¡¹

| é€‰é¡¹            | ç±»å‹   | å¿…éœ€   | é»˜è®¤å€¼  | è¯´æ˜                                                     |
|----------------|--------|--------|---------|----------------------------------------------------------|
| enableLog      | bool   | å¦     | false   | å¯ç”¨è¯¦ç»†æ—¥å¿—è®°å½•ï¼Œç”¨äºè°ƒè¯•ç›®çš„                              |
| Proxy          | array  | æ˜¯     | -       | ä»£ç†é…ç½®æ•°ç»„                                               |

### Proxy é…ç½®

| é€‰é¡¹             | ç±»å‹   | å¿…éœ€   | é»˜è®¤å€¼  | è¯´æ˜                                                     |
|-----------------|--------|--------|---------|----------------------------------------------------------|
| proxyHeadername | string | æ˜¯     | -       | ç”¨äºCDNè¯†åˆ«çš„å¤´éƒ¨åç§°ã€‚ä½¿ç”¨"*"å¯åŒ¹é…æ‰€æœ‰æ¥æº                |
| proxyHeadervalue| string | å¦     | -       | å¤´éƒ¨çš„é¢„æœŸå€¼ã€‚å½“proxyHeadernameä¸º"*"æ—¶ä¸éœ€è¦                |
| realIP          | string | æ˜¯     | -       | ç”¨äºæå–çœŸå®IPçš„å¤´éƒ¨ã€‚ç‰¹æ®Šå€¼"RemoteAddr"å°†ä½¿ç”¨è¿æ¥çš„è¿œç¨‹åœ°å€  |
| OverwriteXFF    | bool   | å¦     | false   | è®¾ä¸ºtrueæ—¶ï¼Œè¿˜ä¼šç”¨æå–çš„çœŸå®IPè¦†ç›–X-Forwarded-Forå¤´éƒ¨(v1.0.2+)|

### å¤„ç†é€»è¾‘

1. æ’ä»¶æŒ‰é¡ºåºæ£€æŸ¥æ¯ä¸ªä»£ç†é…ç½®ã€‚
2. å¯¹äºæ¯ä¸ªé…ç½®ï¼Œå®ƒæ£€æŸ¥è¯·æ±‚æ˜¯å¦å…·æœ‰æŒ‡å®šçš„`proxyHeadername`å’Œå€¼`proxyHeadervalue`ï¼ˆå¦‚æœ`proxyHeadername`ä¸º"*"ï¼Œåˆ™æ¥å—ä»»ä½•è¯·æ±‚ï¼‰ã€‚
3. æ‰¾åˆ°åŒ¹é…é¡¹åï¼Œä»`realIP`æŒ‡å®šçš„å¤´éƒ¨æå–IPã€‚
4. æå–çš„IPè¢«è®¾ç½®ä¸º`X-Real-Ip`å¤´éƒ¨ã€‚
5. å¦‚æœ`OverwriteXFF`ä¸ºtrueï¼Œ`X-Forwarded-For`å¤´éƒ¨ä¹Ÿä¼šè¢«æå–çš„IPè¦†ç›–ã€‚
6. ç„¶åå°†è¯·æ±‚ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå¤„ç†ç¨‹åºã€‚